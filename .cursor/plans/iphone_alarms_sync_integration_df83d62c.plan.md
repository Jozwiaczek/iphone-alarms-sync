---
name: iPhone Alarms Sync Integration
overview: Custom integration for one-way sync of alarms from iPhone/iOS to Home Assistant. iOS Shortcuts call HA services to update alarm state and report events. Integration provides sensor entities, device triggers and events for automations. All code and documentation in English. Compliant with HA Developers guidelines (Bronze quality scale).
todos:
  - id: git-setup
    content: Initialize git repository, create .gitignore, setup initial commit structure
    status: completed
  - id: dev-setup
    content: Verify development tools (Python, pip, ruff, pytest) and create setup instructions
    status: completed
  - id: manifest-const
    content: Create manifest.json and const.py with domain and constants
    status: completed
  - id: coordinator
    content: Implement coordinator.py - data store using ConfigEntry.runtime_data, persistence, auto-create alarms on sync
    status: completed
  - id: config-flow
    content: Implement config_flow.py - Config Flow (phone setup + shortcuts guide + wait for sync) + Options Flow (overview dashboard, alarms list, events history, settings, shortcuts, delete)
    status: completed
    dependencies:
      - manifest-const
      - coordinator
  - id: init-services
    content: Implement __init__.py - setup, sync_alarms (batch) and report_alarm_event services
    status: completed
    dependencies:
      - coordinator
  - id: binary-sensor
    content: Implement binary_sensor.py - enabled, repeats, allows_snooze
    status: completed
    dependencies:
      - coordinator
  - id: sensor
    content: Implement sensor.py - time, repeat_days, last_sync, last_event, last_event_at, shortcut_snippet
    status: completed
    dependencies:
      - coordinator
  - id: device-trigger
    content: Implement device_trigger.py - goes_off, snoozed, stopped triggers
    status: completed
    dependencies:
      - init-services
  - id: services-yaml
    content: Create services.yaml with service definitions
    status: completed
    dependencies:
      - init-services
  - id: translations
    content: Create strings.json and translations/en.json (English UI strings)
    status: completed
  - id: tests
    content: Minimal pytest tests for config_flow and services
    status: completed
  - id: workflow
    content: GitHub Actions workflow with hassfest and pytest
    status: completed
  - id: shortcuts
    content: Create template .shortcut files for import (Sync All Alarms, Alarm Events)
    status: completed
  - id: readme
    content: README.md (English) with Shortcuts import guide and music automation example
    status: completed
---

# iPhone Alarms Sync - Custom Integration for Home Assistant

## Architecture

```mermaid
flowchart TB
    subgraph iPhone
        ClockApp[Clock App]
        Shortcuts[iOS Shortcuts]
        MobileApp[HA Mobile App]
    end
    
    subgraph HomeAssistant[Home Assistant]
        subgraph Integration[iphone_alarms_sync]
            ConfigFlow[Config Flow<br/>Add phone + optional Mobile App link]
            OptionsFlow[Options Flow<br/>View/Edit/Delete alarms]
            Services[Services<br/>sync_alarms / report_alarm_event]
            DeviceTriggers[Device Triggers<br/>goes_off / snoozed / stopped]
        end
        
        subgraph Devices[Devices - auto-created]
            MobileAppDevice[Mobile App Device<br/>optional, visual only]
            Phone[Phone Device]
            Alarm1[Alarm Device 1]
            Alarm2[Alarm Device 2]
        end
        
        subgraph Entities
            BinarySensors[Binary Sensors<br/>enabled, repeats, allows_snooze]
            Sensors[Sensors<br/>time, repeat_days, last_sync, etc.]
        end
        
        Events[HA Events<br/>iphone_alarms_sync_alarm_event]
        Automations[Automations]
    end
    
    ClockApp -->|on exit trigger| Shortcuts
    Shortcuts -->|HA Companion: Call Service| Services
    Shortcuts -->|sync_alarms / report_alarm_event| Services
    MobileApp -.->|registered| MobileAppDevice
    Services -->|auto-create| Devices
    Devices --> Entities
    Services --> Events
    Events --> Automations
    DeviceTriggers --> Automations
    MobileAppDevice -.-> Phone
    Phone --> Alarm1
    Phone --> Alarm2
```



## File Structure

```javascript
iphone-alarms-sync/
├── custom_components/iphone_alarms_sync/
│   ├── __init__.py          # Main logic, setup, services
│   ├── manifest.json        # Integration metadata
│   ├── const.py             # Constants (domain, platforms, keys)
│   ├── config_flow.py       # Config + Options Flow
│   ├── coordinator.py       # Data store, persistence, auto-create
│   ├── binary_sensor.py     # Binary sensors per alarm
│   ├── sensor.py            # Sensors per alarm
│   ├── device_trigger.py    # Device triggers per alarm
│   ├── services.yaml        # Service definitions
│   ├── strings.json         # UI strings
│   └── translations/
│       └── en.json          # English translations
├── shortcuts/
│   ├── Sync All Alarms.shortcut
│   ├── Alarm Goes Off.shortcut
│   ├── Alarm Snoozed.shortcut
│   └── Alarm Stopped.shortcut
├── tests/
│   ├── conftest.py
│   ├── test_config_flow.py
│   └── test_services.py
├── .github/workflows/
│   └── validate.yml
├── hacs.json
└── README.md
```



## Key Implementation Details

### 1. Config Flow + Options Flow

**Config Flow** - adding phone (one config entry per phone):Step 1: Phone setup

- `mobile_app_device` (optional) - dropdown with Mobile App devices
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - **Purpose**: Only for better identification and auto-filling phone name
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - **No functional dependency** - integration works perfectly without it
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - If selected → `phone_name` auto-filled from Mobile App device name (editable)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - If **not selected** → user only needs to enter `phone_name` manually (simple!)
- `phone_id` - **auto-generated** from `phone_name` (slugify)

Step 2: Shortcuts import guide

- Download link for `.shortcut` files
- QR code to scan with iPhone (opens iCloud Shortcuts link)
- Instructions: "Import shortcuts, enter your HA URL and phone_id"

Step 3: Waiting for first sync

- Shows "Waiting for first sync..." status
- Auto-proceeds when first `sync_alarms` call received
- Option to skip and configure later

**Options Flow** - phone settings & diagnostics (available after first successful sync):Main menu:

1. **Overview** - visual dashboard with:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Last sync time and status indicator
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Total alarms count
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Recent events timeline (last 10 events)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Quick stats (enabled alarms, events today, etc.)

2. **Alarms** - detailed list with:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Visual cards showing each alarm (icon, label, time, enabled status)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Edit alarm: label, icon customization
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Delete stale alarms
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Click alarm → detailed view (sync history, events, state)

3. **Events History** - chronological list of all events:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Filter by event type (goes_off/snoozed/stopped)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Filter by alarm
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Date/time, alarm name, event type
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Visual timeline view

4. **Phone Settings**:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Edit phone_name
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Link/unlink Mobile App device (visual organization only)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - View device info (phone_id, linked Mobile App device if any)

5. **Shortcuts Setup** - re-show download links + QR codes
6. **Delete Phone** - remove this phone and all its alarms

Alarms are **auto-created** when first synced from iPhone via `sync_alarms` service.Data stored in `config_entry.data` (phone config) and `config_entry.options` (alarms state)

### 2. Device Hierarchy & Cross-References

```mermaid
flowchart LR
    MobileApp[Mobile App Device<br/>optional, visual only] -.->|via_device<br/>optional| Phone[Phone Device<br/>iphone_alarms_sync]
    MobileApp -.->|shows reference| Phone
    Phone --> Alarm1[Alarm Device 1]
    Phone --> Alarm2[Alarm Device 2]
```



- **Mobile App Device** (optional) = existing device from `mobile_app` integration
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - **Purpose**: Visual organization and name auto-fill only
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - **No functional dependency** - all features work without it
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - **Cross-reference**: If linked, Mobile App device page shows reference to our phone device
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Implemented via device registry attributes or custom device info
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Shows link like "Related: iPhone Alarms Sync - John's iPhone"
- **Phone** = device created by this integration
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `via_device` set to Mobile App device **only if** user selected it in config
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - If not selected, phone device is standalone (no via_device)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - After first successful sync → full Options Flow available (overview, alarms, events, settings)
- **Alarm** = child device (`via_device` always points to phone device), auto-created on first sync

### 3. Entities per Alarm

**Binary Sensors:**

- `binary_sensor.{phone_id}_{alarm_id}_enabled`
- `binary_sensor.{phone_id}_{alarm_id}_repeats`
- `binary_sensor.{phone_id}_{alarm_id}_allows_snooze`

**Sensors:**

- `sensor.{phone_id}_{alarm_id}_time` (format HH:MM)
- `sensor.{phone_id}_{alarm_id}_repeat_days` (e.g. "Mon,Tue,Wed")
- `sensor.{phone_id}_{alarm_id}_last_sync` (ISO datetime)
- `sensor.{phone_id}_{alarm_id}_last_event` (goes_off/snoozed/stopped)
- `sensor.{phone_id}_{alarm_id}_last_event_at` (ISO datetime)
- `sensor.{phone_id}_{alarm_id}_shortcut_snippet` (JSON with ready-to-use payloads)

### 4. Services

**`iphone_alarms_sync.sync_alarms`** (batch sync, auto-creates alarms):

- Required: `phone_id`
- Required: `alarms` - list of alarm objects, each with:
- `alarm_id` (string) - iOS alarm identifier
- `label` (string) - alarm name
- `enabled` (bool)
- `hour` (int 0-23)
- `minute` (int 0-59)
- `repeats` (bool)
- `repeat_days` (list: mon/tue/wed/thu/fri/sat/sun)
- `allows_snooze` (bool)
- Generated: `synced_at` (UTC ISO) - stored per alarm

**`iphone_alarms_sync.report_alarm_event`:**

- Required: `phone_id`, `alarm_id`, `event` (goes_off/snoozed/stopped)
- Generated: `occurred_at` (UTC ISO), `event_id` (UUID)
- Fires event: `iphone_alarms_sync_alarm_event`
- Triggers device automation for the specific alarm

### 5. Device Triggers

For each alarm device:

- `goes_off` - alarm fired
- `snoozed` - alarm was snoozed
- `stopped` - alarm was stopped/dismissed

### 6. Data Persistence

- Config entry stores phone config (`data`) and alarms metadata (`options`)
- Runtime alarm state stored in `ConfigEntry.runtime_data` (typed dataclass)
- Persistent data saved to config entry via `async_update_entry`
- Survives HA restarts
- Modern pattern: No `hass.data[DOMAIN]` - use typed runtime_data instead

### 7. Cross-Reference to Mobile App Device

If user linked Mobile App device during setup:

- Phone device has `via_device` pointing to Mobile App device
- **Reverse reference**: Mobile App device page shows link to our phone device
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Implementation: Add device info attribute or use device registry connections
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Shows as "Related device: iPhone Alarms Sync - [phone_name]"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Clickable link to phone device page in our integration

## Onboarding Flow

```mermaid
flowchart TD
    Start[User adds integration] --> Step1[Step 1: Enter phone name<br/>or select Mobile App device]
    Step1 --> Step2[Step 2: Shortcuts setup<br/>Download links + QR codes]
    Step2 --> Step3[Step 3: Waiting for first sync...]
    Step3 -->|sync_alarms received| Done[Setup complete!<br/>Alarms auto-created]
    Step3 -->|Skip| Later[Configure later in Options]
    Done --> Options[Options Flow:<br/>Status, Alarms, Settings]
    Later --> Options
```



## Data Flow (one-way sync via HA Companion App)

```mermaid
sequenceDiagram
    participant Clock as Clock App
    participant Shortcut as iOS Shortcuts
    participant Companion as HA Companion App
    participant HA as Home Assistant
    participant Auto as Automations
    
    Note over Clock,HA: Batch sync all alarms (on Clock app exit)
    Clock->>Shortcut: Personal Automation trigger
    Shortcut->>Shortcut: Get All Alarms from Clock
    Shortcut->>Companion: Call Service action
    Companion->>HA: sync_alarms(phone_id, alarms[...])
    HA->>HA: Auto-create new alarm devices
    HA->>HA: Update all sensor entities
    
    Note over Clock,Auto: Report alarm events
    Clock->>Shortcut: Alarm trigger (goes_off/snoozed/stopped)
    Shortcut->>Companion: Call Service action
    Companion->>HA: report_alarm_event(phone_id, alarm_id, event)
    HA->>HA: Generate event_id, occurred_at
    HA->>HA: Fire event iphone_alarms_sync_alarm_event
    HA->>Auto: Device trigger
    Auto->>Auto: Execute automation
```



## Example Service Call Payloads

Passed via **HA Companion App's "Call Service" action** in Shortcuts:**sync_alarms** - batch sync all alarms from iPhone:

```json
{
  "phone_id": "johns_iphone",
  "alarms": [
    {
      "alarm_id": "ABC123",
      "label": "Wake Up",
  "enabled": true,
  "hour": 7,
      "minute": 0,
      "repeats": true,
      "repeat_days": ["mon", "tue", "wed", "thu", "fri"],
      "allows_snooze": true
    },
    {
      "alarm_id": "DEF456",
      "label": "Gym",
      "enabled": false,
      "hour": 6,
  "minute": 30,
      "repeats": false,
      "repeat_days": [],
      "allows_snooze": false
    }
  ]
}
```

**report_alarm_event** - report when alarm fires/snoozes/stops:

```json
{
  "phone_id": "johns_iphone",
  "alarm_id": "ABC123",
  "event": "goes_off"
}
```



## Template Shortcuts (using HA Companion App actions)

Uses **HA Companion App's built-in Shortcuts actions** instead of raw HTTP:

- No manual URL configuration needed
- Authentication handled automatically by app
- Works with internal/external URLs seamlessly
- Multi-server support built-in

**Shortcuts in `shortcuts/` folder:**

1. `Sync All Alarms.shortcut`

- Trigger: Personal Automation → "App" → "Clock" → "Is Closed"
- Action: **Call Service** → `iphone_alarms_sync.sync_alarms`
- Uses "Get All Alarms" + Dictionary for payload

2. `Alarm Goes Off.shortcut`

- Trigger: Personal Automation → "Alarm" → "Goes Off"
- Action: **Call Service** → `iphone_alarms_sync.report_alarm_event`
- Payload: `{ phone_id, alarm_id, event: "goes_off" }`

3. `Alarm Snoozed.shortcut`

- Trigger: Personal Automation → "Alarm" → "Is Snoozed"
- Action: **Call Service** → `iphone_alarms_sync.report_alarm_event`

4. `Alarm Stopped.shortcut`

- Trigger: Personal Automation → "Alarm" → "Is Stopped"
- Action: **Call Service** → `iphone_alarms_sync.report_alarm_event`

**Import methods (shown in Config Flow UI):**

1. Download link - direct `.shortcut` file download
2. QR code - scan with iPhone camera, opens iCloud Shortcuts link

User only needs to set `phone_id` once per shortcut (no URL/auth needed).**iOS 17+**: Personal Automations with alarm triggers run automatically without interaction.

## Home Assistant Developers Compliance

Implementation follows HA Developers guidelines for **Bronze quality scale** (minimum for new integrations):

### manifest.json Requirements

```json
{
  "domain": "iphone_alarms_sync",
  "name": "iPhone Alarms Sync",
  "version": "1.0.0",
  "documentation": "https://github.com/USER/iphone-alarms-sync",
  "issue_tracker": "https://github.com/USER/iphone-alarms-sync/issues",
  "codeowners": ["@USER"],
  "config_flow": true,
  "iot_class": "cloud_push",
  "requirements": []
}
```



### Coding Standards

- **PEP8 & PEP 257** compliant
- **Ruff** formatter configuration included
- **No comments** in code (per user preference)
- **F-strings** for string formatting
- **No secrets** logged (phone_id is not sensitive)
- **Type hints** on all functions

### Modern HA Patterns

1. **ConfigEntry.runtime_data** - use typed runtime data instead of `hass.data[DOMAIN]`
```python
@dataclass
class IPhoneAlarmsSyncData:
    coordinator: IPhoneAlarmsSyncCoordinator
    
type IPhoneAlarmsSyncConfigEntry = ConfigEntry[IPhoneAlarmsSyncData]
```




2. **Entity unique_id** - format: `{entry_id}_{alarm_id}_{entity_type}`

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Example: `abc123_alarm1_enabled`

3. **Device identifiers** - tuple format: `(DOMAIN, phone_id)` and `(DOMAIN, phone_id, alarm_id)`
4. **Entity naming** - follows HA naming conventions:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Entity ID: `{domain}.{phone_id}_{alarm_id}_{name}`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Example: `sensor.johns_iphone_morning_alarm_time`

5. **Async-first** - all I/O operations use async/await
6. **No polling** - push-based via services (iot_class: cloud_push)

### Config Flow Patterns

- Multi-step config flow with progress indicators
- Options flow for settings after setup
- Proper error handling with user-friendly messages
- Reauth flow if needed (not applicable for this integration)

### Testing Requirements

- **test_config_flow.py** - config flow tests
- **test_services.py** - service call tests
- **conftest.py** - fixtures and mocks

### HACS Compatibility

- Single integration per repository
- `hacs.json` with proper configuration
- All files in `custom_components/iphone_alarms_sync/`

### GitHub Actions Workflow

```yaml
# .github/workflows/validate.yml
- hassfest: Validates manifest.json, services.yaml, translations
- pytest: Runs test suite
- ruff: Linting and formatting check
```

**iOS 17+**: Personal Automations with alarm triggers run automatically.

## Development Setup & Requirements

### Quick Start (TL;DR)

```bash
# 1. Install tools via Homebrew
brew install pyenv uv git

# 2. Setup pyenv
echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.zshrc
echo '[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.zshrc
echo 'eval "$(pyenv init -)"' >> ~/.zshrc
exec $SHELL

# 3. Install Python 3.13
pyenv install 3.13
pyenv local 3.13

# 4. Initialize project
git init
uv init --no-readme
uv venv
source .venv/bin/activate

# 5. Install dev dependencies
uv tool install ruff mypy
uv pip install pytest pytest-asyncio pytest-homeassistant-custom-component homeassistant pre-commit

# 6. Verify
python --version  # Should be 3.13.x
uv --version
ruff --version
pytest --version
```



### Required Tools (Modern Stack)

**Homebrew (macOS package manager):**

- Install: `/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"`
- Check: `brew --version`

**pyenv (Python version management):**

- Install via brew: `brew install pyenv`
- Setup shell: Add to `~/.zshrc`:
  ```bash
    export PYENV_ROOT="$HOME/.pyenv"
    [[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"
  ```




- Reload shell: `exec $SHELL`
- Check: `pyenv --version`

**Python 3.13:**

- Install via pyenv: `pyenv install 3.13`
- Set local version: `pyenv local 3.13`
- Check: `python --version` (should show 3.13.x)

**uv (Fast Python package manager):**

- Install via brew: `brew install uv`
- Or install script: `curl -LsSf https://astral.sh/uv/install.sh | sh`
- Check: `uv --version`

**Development Tools (via uv):**

- `ruff` - linting and formatting
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Install: `uv tool install ruff`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Check: `ruff --version`
- `pytest` - testing framework
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Install: `uv pip install pytest pytest-asyncio pytest-homeassistant-custom-component`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Check: `pytest --version`
- `hassfest` - HA manifest validation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Install: `uv pip install homeassistant`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Check: `hassfest --version`

**Git:**

- Usually pre-installed on macOS
- Or via brew: `brew install git`
- Check: `git --version`

**Optional but Recommended:**

- `pre-commit` - git hooks for automatic checks
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Install: `uv pip install pre-commit`
- `mypy` - type checking
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Install: `uv tool install mypy`
- `hatch` or `poetry` - project management (optional, uv handles this)

### Git Repository Setup

**Initial Setup:**

```bash
# Initialize repository
git init
git branch -M main

# Create .gitignore
cat > .gitignore << EOF
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
ENV/
.venv/
.python-version

# pyenv
.python-version

# uv
.uv/
uv.lock

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# Testing
.pytest_cache/
.coverage
htmlcov/
.tox/
.mypy_cache/

# Home Assistant
.homeassistant/

# OS
.DS_Store
Thumbs.db

# Project specific
*.shortcut
EOF

# Initial commit structure
git add .gitignore
git commit -m "Initial commit: Add .gitignore"
```

**Repository Structure:**

```javascript
iphone-alarms-sync/
├── .git/
├── .gitignore
├── .github/workflows/
│   └── validate.yml
├── custom_components/
│   └── iphone_alarms_sync/
├── shortcuts/
├── tests/
├── hacs.json
└── README.md
```



### Development Environment Setup

**1. Setup Python 3.13 with pyenv:**

```bash
# Install pyenv if not already installed
brew install pyenv

# Add to ~/.zshrc (if not already added)
echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.zshrc
echo '[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.zshrc
echo 'eval "$(pyenv init -)"' >> ~/.zshrc

# Reload shell
exec $SHELL

# Install Python 3.13
pyenv install 3.13

# Set local version for this project
pyenv local 3.13
```

**2. Install uv:**

```bash
# Via Homebrew (recommended)
brew install uv

# Or via install script
curl -LsSf https://astral.sh/uv/install.sh | sh
```

**3. Create project with uv:**

```bash
# Initialize project (creates pyproject.toml)
uv init --no-readme

# Create virtual environment and install dependencies
uv venv
source .venv/bin/activate  # uv creates .venv by default
```

**4. Install development dependencies:**

```bash
# Install tools via uv
uv tool install ruff mypy

# Install Python packages
uv pip install pytest pytest-asyncio pytest-homeassistant-custom-component homeassistant pre-commit
```

**5. Create pyproject.toml (if not auto-generated):**

```toml
[project]
name = "iphone-alarms-sync"
version = "0.1.0"
description = "Home Assistant custom integration for iPhone alarms sync"
requires-python = ">=3.13"
dependencies = []

[project.optional-dependencies]
dev = [
    "pytest>=7.0.0",
    "pytest-asyncio>=0.21.0",
    "pytest-homeassistant-custom-component>=0.10.0",
    "homeassistant",
    "pre-commit",
]

[tool.ruff]
line-length = 88
target-version = "py313"

[tool.ruff.lint]
select = ["E", "F", "I", "N", "W"]
ignore = []

[tool.mypy]
python_version = "3.13"
warn_return_any = true
warn_unused_configs = true
```

**6. Verify tools:**

```bash
python --version  # Should be 3.13.x
uv --version
ruff --version
pytest --version
git --version
```



### Pre-commit Hooks (Optional)

```bash
# Install pre-commit via uv
uv pip install pre-commit

# Create .pre-commit-config.yaml
cat > .pre-commit-config.yaml << EOF
repos:
    - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.0
    hooks:
            - id: ruff
        args: [--fix]
            - id: ruff-format
EOF

# Install hooks
pre-commit install
```



### Quick Verification Checklist

Before starting implementation, verify:

- [ ] Homebrew installed (`brew --version`)
- [ ] pyenv installed (`pyenv --version`)
- [ ] Python 3.13 installed via pyenv (`pyenv install 3.13`)
- [ ] Python 3.13 set as local version (`pyenv local 3.13`)
- [ ] uv installed (`uv --version`)
- [ ] ruff installed via uv (`uv tool install ruff`)
- [ ] pytest installed (`uv pip install pytest`)
- [ ] git installed and configured (`git --version`)
- [ ] Git repository initialized (`git init`)
- [ ] .gitignore created
- [ ] Virtual environment created with uv (`uv venv`)